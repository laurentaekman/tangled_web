import type { NextPage } from "next";
import Head from "next/head";
import Link from "next/link";
import { useContext, useEffect, useState } from "react";
import styles from "../styles/WelcomePage.module.css";
import ObjectsContext from "../context/objects-context";
import { getArtObjects } from "../utils/api";
import { useFavorites } from "../hooks/use-favorites";
import { ArtObject } from "../utils/types";
import { RightArrowIcon } from "../assets/RightArrowIcon";
import { QuestionIcon } from "../assets/QuestionIcon";

const WelcomePage: NextPage = () => {
  const [artObjects, setArtObjects] = useState<ArtObject[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [favorites] = useFavorites();
  const objectsContext = useContext(ObjectsContext);

  useEffect(() => {
    let newObjects: ArtObject[] = [];
    const objectIds: number[] = objectsContext.objectWithImagesIds;
    if (favorites.length > 2) {
      newObjects = favorites
        .filter((favorite: ArtObject) => favorite.imageSource)
        .splice(0, 2);
      // console.log(newObjects);
    }

    const getObjects = async () => {
      let objects;
      let indexes: number[] = [];
      for (let i = 0; i < 2; i++) {
        let newIndex = Math.floor(Math.random() * (objectIds.length - 0 + 1));
        if (!indexes.some((index) => index === newIndex)) {
          newIndex = Math.floor(Math.random() * (newIndex - 0 + 1));
        }
        indexes.push(newIndex);
      }
      const newObjectIds = indexes.map((index) => objectIds[index]);
      objects = await getArtObjects(newObjectIds);
      // console.log(objects);
      setArtObjects(objects);
    };

    if (newObjects.length < 2 && objectIds.length > 0) {
      getObjects();
    } else {
      setArtObjects(newObjects);
    }
  }, [favorites, objectsContext.objectWithImagesIds]);

  return (
    <div>
      <Head>
        <title>Tangled Web</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main className={styles.main}>
        <div className={styles.images}>
          <div className={styles.primary_image_frame}>
            <div className={styles.primary_cropped_image}>
              {artObjects[0] ? (
                // eslint-disable-next-line @next/next/no-img-element
                <img
                  src={artObjects[0].imageSource}
                  alt={artObjects[0].title}
                  className={styles.primary_image}
                />
              ) : (
                <div className={styles.primary_image}>
                  <QuestionIcon />
                </div>
              )}
            </div>
          </div>
          <div className={styles.secondary_image_frame}>
            <div className={styles.secondary_cropped_image}>
              {artObjects[1] ? (
                // eslint-disable-next-line @next/next/no-img-element
                <img
                  src={artObjects[1].imageSource}
                  alt={artObjects[1].title}
                  className={styles.secondary_image}
                />
              ) : (
                <div className={styles.secondary_image}>
                  <QuestionIcon />
                </div>
              )}
            </div>
          </div>
        </div>

        <div className={styles.main_text}>
          <h1>Tangled Web (Art Edition)</h1>
          <h2>
            Explore a variety of pieces from the Metropolitan Museum of Art.
          </h2>
          <Link href="/home">
            <a>
              Get Started
              <RightArrowIcon />
            </a>
          </Link>
        </div>
      </main>
    </div>
  );
};

export default WelcomePage;
